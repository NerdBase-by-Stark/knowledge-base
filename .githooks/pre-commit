#!/bin/bash
#===============================================================================
# Pre-commit hook: Security audit for sensitive information
# Blocks commits containing personal data, keys, IPs, etc.
#===============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if we found any issues
FOUND_ISSUE=0

# Get list of staged files (excluding hook files themselves)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v "^\.githooks/" | grep -v "^scripts/install-hooks\.sh")

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${YELLOW}Running security audit on staged files...${NC}"

#===============================================================================
# PATTERNS TO BLOCK
#===============================================================================

# 1. Personal home directory paths
if git diff --cached | grep -E "^\+.*(/home/[a-z][-a-z0-9_]*)" | grep -v "/home/username" | grep -v "~/"; then
    echo -e "${RED}✗ BLOCKED: Found hardcoded home directory path (e.g., /home/username)${NC}"
    echo "  Use environment variables or relative paths instead"
    git diff --cached | grep -n --color=auto "^\+.*/home/[a-z]"
    FOUND_ISSUE=1
fi

# 2. Tailscale IPs (100.x.x.x range)
if git diff --cached | grep -E "^\+.*\b100\.(1[0-9]{2}|2[0-4][0-9]|25[0-5]|[1-9][0-9]?)\.[0-9]{1,3}\.[0-9]{1,3}\b"; then
    echo -e "${RED}✗ BLOCKED: Found Tailscale IP address (100.x.x.x)${NC}"
    echo "  Use localhost instead or environment variables"
    git diff --cached | grep -n --color=auto "^\+.*100\."
    FOUND_ISSUE=1
fi

# 3. Local/private IPs (192.168.x.x, 10.x.x.x, 172.16-31.x.x)
if git diff --cached | grep -E "^\+.*\b(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.)"; then
    echo -e "${RED}✗ BLOCKED: Found private/local IP address${NC}"
    echo "  Use localhost, environment variables, or configuration files"
    git diff --cached | grep -n --color=auto "^\+.*\(192\.168\.\|10\.\|172\.\)"
    FOUND_ISSUE=1
fi

# 4. API keys and tokens (common patterns)
if git diff --cached | grep -E "^\+.*(api[_-]?key|apikey|access[_-]?token|auth[_-]?token|secret|api[_-]?secret)['\"]?\s*[:=]\s*['\"][^'\"]{8,}"; then
    echo -e "${RED}✗ BLOCKED: Possible API key or token detected${NC}"
    echo "  Use environment variables instead"
    git diff --cached | grep -n --color=auto "^\+.*\(api[_-]key\|apikey\|access[_-]token\|auth[_-]token\|secret\)"
    FOUND_ISSUE=1
fi

# 5. Generic "key" or "secret" assignments with long values
if git diff --cached | grep -E "^\+.*['\"]?(key|secret|token|password|passwd)['\"]?\s*[:=]\s*['\"][a-zA-Z0-9+/]{20,}"; then
    echo -e "${RED}✗ BLOCKED: Possible hardcoded secret/password${NC}"
    echo "  Use environment variables"
    git diff --cached | grep -n --color=auto "^\+.*\(key\|secret\|token\|password\|passwd\).{20,}"
    FOUND_ISSUE=1
fi

# 6. Email addresses (optionally block - comment out if not needed)
if git diff --cached | grep -E "^\+.*\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b" | grep -v "noreply\|github\|example\.com"; then
    echo -e "${RED}✗ BLOCKED: Found email address${NC}"
    echo "  Use environment variables or remove emails from code"
    git diff --cached | grep -n --color=auto "@"
    FOUND_ISSUE=1
fi

# 7. SSH private key markers
if git diff --cached | grep -E "^\+.*-----BEGIN.*(RSA|PRIVATE|OPENSSH) KEY-----"; then
    echo -e "${RED}✗ BLOCKED: SSH private key detected!${NC}"
    echo "  NEVER commit private keys"
    FOUND_ISSUE=1
fi

# 8. Common credential patterns
if git diff --cached | grep -iE "^\+.*(ghp_|gho_|ghu_|ghs_|ghr_|github_pat_|sk-|sk_|pk_|api_key|apikey|secret_key|secretkey|access_key)"; then
    echo -e "${RED}✗ BLOCKED: Found credential pattern${NC}"
    git diff --cached | grep -n --color=auto "^\+.*\(ghp_\|gho_\|sk-\|pk_\|api_key\)"
    FOUND_ISSUE=1
fi

# 9. Known local usernames (customize this list)
KNOWN_USERNAMES="spark-bitch|admin|root|user|username"
if git diff --cached | grep -E "^\+.*(/home/($KNOWN_USERNAMES)|/Users/($KNOWN_USERNAMES))"; then
    echo -e "${RED}✗ BLOCKED: Found hardcoded username in path${NC}"
    git diff --cached | grep -n --color=auto "^\+.*(/home/($KNOWN_USERNAMES))"
    FOUND_ISSUE=1
fi

# 10. Base64 encoded secrets (long base64 strings)
if git diff --cached | grep -E "^\+.*[A-Za-z0-9+/]{40,}={0,2}"; then
    echo -e "${YELLOW}⚠ WARNING: Possible base64 encoded data${NC}"
    echo "  Review this line:"
    git diff --cached | grep -n --color=auto "^\+.*[A-Za-z0-9+/]{40,}={0,2}"
    # This is a warning, not a block - but you can change FOUND_ISSUE=1 if wanted
fi

#===============================================================================
# RESULT
#===============================================================================

if [ $FOUND_ISSUE -eq 1 ]; then
    echo ""
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}COMMIT BLOCKED${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo "Fix the issues above, or use 'git commit --no-verify' to bypass (not recommended)"
    echo ""
    echo "To bypass this hook (dangerous):"
    echo "  git commit --no-verify -m 'message'"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ Security audit passed${NC}"
exit 0
